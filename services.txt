# chatbot/services.py
import random
from datetime import datetime

class MindTrackChatbot:
    """Simple rule-based chatbot for MindTrack"""
    
    # Mood-based responses
    MOOD_RESPONSES = {
        'happy': [
            "That's wonderful! Happiness is contagious ðŸ˜Š",
            "So glad to hear you're feeling happy! Keep shining! âœ¨",
            "Your positive energy is inspiring!",
            "Happiness looks great on you!",
            "Celebrate these happy moments! ðŸŽ‰"
        ],
        'sad': [
            "I'm here for you. It's okay to feel sad sometimes ðŸ’™",
            "Take your time. These feelings will pass.",
            "Remember, you're stronger than you think.",
            "Would you like to talk about what's bothering you?",
            "Sending you virtual hugs ðŸ¤—"
        ],
        'angry': [
            "Take a deep breath. You've got this ðŸŒ¬ï¸",
            "It's okay to feel angry. Try taking a short walk.",
            "Count to 10 slowly. You're in control.",
            "Anger is temporary. You'll find calm soon.",
            "Try writing down what's bothering you."
        ],
        'fear': [
            "You're safe here. Take it one step at a time ðŸ›¡ï¸",
            "Fear is just a feeling. You're braver than you know.",
            "What's the smallest step you can take right now?",
            "Remember past times you overcame fear.",
            "Focus on your breathing. In... and out..."
        ],
        'neutral': [
            "Sometimes neutral is perfectly fine ðŸ˜",
            "Taking it easy today? That's okay too!",
            "Mindfulness can help you connect with your feelings.",
            "How about a quick gratitude check?",
            "Balance is beautiful."
        ],
        'surprise': [
            "Wow! That sounds exciting! ðŸ˜²",
            "Life's surprises can be wonderful!",
            "Embrace the unexpected!",
            "That's quite a development!",
            "Stay curious about what comes next!"
        ]
    }
    
    # Activity suggestions based on mood
    ACTIVITY_SUGGESTIONS = {
        'happy': [
            "Share your happiness with someone",
            "Dance to your favorite song",
            "Write about what made you happy today",
            "Do something creative",
            "Spread kindness to others"
        ],
        'sad': [
            "Listen to calming music",
            "Watch a favorite movie",
            "Write in a journal",
            "Take a warm bath",
            "Call a friend or family member"
        ],
        'angry': [
            "Go for a brisk walk",
            "Try some deep breathing exercises",
            "Punch a pillow (safely)",
            "Listen to intense music",
            "Write a letter (don't send it)"
        ],
        'fear': [
            "Practice grounding techniques",
            "Make a plan for small steps",
            "Talk to someone you trust",
            "Write down worst-case scenarios (then challenge them)",
            "Try progressive muscle relaxation"
        ],
        'neutral': [
            "Try a new hobby",
            "Read a book",
            "Go for a nature walk",
            "Learn something new",
            "Organize your space"
        ],
        'surprise': [
            "Document this moment",
            "Share the surprise with someone",
            "Reflect on how you feel",
            "Stay open to possibilities",
            "Celebrate the unexpected"
        ]
    }
    
    # Motivational quotes
    MOTIVATIONAL_QUOTES = [
        "You are capable of amazing things ðŸ’«",
        "Progress, not perfection",
        "One day at a time",
        "You've survived 100% of your bad days",
        "Small steps still move you forward",
        "Your mental health is a priority",
        "Be gentle with yourself today",
        "You're doing better than you think",
        "This feeling is temporary",
        "You are enough, just as you are"
    ]
    
    # Greetings and general responses
    GREETINGS = [
        "Hello! How are you feeling today? ðŸ˜Š",
        "Hi there! Ready to explore your emotions?",
        "Welcome back! How can I support you today?",
        "Hello! I'm here to listen and help ðŸŒŸ"
    ]
    
    FAREWELLS = [
        "Take care of yourself! Come back anytime ðŸŒˆ",
        "Remember to be kind to yourself today ðŸ’–",
        "Wishing you peace and clarity âœ¨",
        "You've got this! See you soon ðŸŒŸ"
    ]
    
    @staticmethod
    def get_response(user_message, user_mood=None):
        """Generate a chatbot response based on user input"""
        user_message_lower = user_message.lower().strip()
        
        # Check for greetings
        greetings = ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good afternoon', 'good evening']
        if any(greet in user_message_lower for greet in greetings):
            return random.choice(MindTrackChatbot.GREETINGS)
        
        # Check for farewells
        farewells = ['bye', 'goodbye', 'see you', 'farewell', 'quit', 'exit']
        if any(farewell in user_message_lower for farewell in farewells):
            return random.choice(MindTrackChatbot.FAREWELLS)
        
        # Check for help requests
        if 'help' in user_message_lower or 'support' in user_message_lower:
            return "I'm here to help! You can: 1) Share your feelings 2) Ask for activity suggestions 3) Request motivational quotes 4) Just chat with me ðŸ’¬"
        
        # Check for activity requests
        if 'activity' in user_message_lower or 'what should i do' in user_message_lower or 'suggestion' in user_message_lower:
            if user_mood:
                activities = MindTrackChatbot.ACTIVITY_SUGGESTIONS.get(user_mood, MindTrackChatbot.ACTIVITY_SUGGESTIONS['neutral'])
                return f"Based on your mood, try this: {random.choice(activities)}"
            else:
                return "Try: Take 5 deep breaths, write 3 things you're grateful for, or listen to your favorite song ðŸŽµ"
        
        # Check for quote requests
        if 'quote' in user_message_lower or 'motivate' in user_message_lower or 'inspiration' in user_message_lower:
            return f"ðŸ’« {random.choice(MindTrackChatbot.MOTIVATIONAL_QUOTES)}"
        
        # Mood-based responses
        if user_mood:
            responses = MindTrackChatbot.MOOD_RESPONSES.get(user_mood, MindTrackChatbot.MOOD_RESPONSES['neutral'])
            response = random.choice(responses)
            
            # Sometimes add an activity suggestion
            if random.random() > 0.7:  # 30% chance
                activities = MindTrackChatbot.ACTIVITY_SUGGESTIONS.get(user_mood, MindTrackChatbot.ACTIVATION_SUGGESTIONS['neutral'])
                response += f" You could also try: {random.choice(activities)}"
            
            return response
        
        # Default empathetic responses
        empathetic_responses = [
            "Thanks for sharing that with me ðŸ¤—",
            "I hear you. Tell me more if you'd like ðŸ’­",
            "That sounds important. How does that make you feel?",
            "I'm listening. Your feelings are valid ðŸ’«",
            "Thank you for being open with me ðŸŒŸ"
        ]
        
        return random.choice(empathetic_responses)
    
    @staticmethod
    def analyze_mood_from_text(text):
        """Simple mood detection from text (similar to dashboard)"""
        text_lower = text.lower()
        
        mood_keywords = {
            'happy': ['happy', 'joy', 'good', 'great', 'wonderful', 'excited', 'love', 'amazing', 'fantastic'],
            'sad': ['sad', 'unhappy', 'depressed', 'cry', 'tears', 'lonely', 'miserable', 'bad', 'terrible'],
            'angry': ['angry', 'mad', 'hate', 'annoyed', 'furious', 'rage', 'frustrated', 'irritated'],
            'fear': ['fear', 'scared', 'afraid', 'anxious', 'worried', 'nervous', 'panic', 'anxiety'],
            'neutral': ['okay', 'fine', 'normal', 'alright', 'meh', 'whatever', 'ok'],
            'surprise': ['surprise', 'wow', 'shocked', 'unexpected', 'amazing', 'unbelievable']
        }
        
        scores = {mood: 0 for mood in mood_keywords}
        
        for mood, keywords in mood_keywords.items():
            for keyword in keywords:
                if keyword in text_lower:
                    scores[mood] += 1
        
        if all(score == 0 for score in scores.values()):
            return None
        
        return max(scores, key=scores.get)


        # chatbot/services.py
import random
from datetime import datetime
from typing import List, Dict, Optional

class MindTrackChatbot:
    """Enhanced rule-based chatbot for MindTrack with mood-specific songs and no repetition"""
    
    # Track conversation state
    _conversation_state = {
        'last_quotes_given': [],
        'last_songs_given': [],  # Track given songs to avoid repetition
        'cheer_up_context': False,
        'last_interaction': None,
        'interaction_count': 0,
        'current_mood': None
    }
    
    # Enhanced mood-based responses with professional tone
    MOOD_RESPONSES = {
        'happy': [
            "It's wonderful to hear you're experiencing happiness! These moments are precious for our wellbeing. What's bringing you this joy today? ðŸ˜Š",
            "Your positive energy is truly uplifting! Celebrating these good moments helps build emotional resilience. âœ¨",
            "Happiness looks great on you! Noticing what creates these positive states can help us cultivate more of them in daily life.",
            "That's fantastic! Positive emotions like happiness help broaden our perspective and build psychological resources.",
            "I'm delighted to hear you're feeling happy! Would you like to explore how to extend or deepen this positive state?"
        ],
        'sad': {
            'general': [
                "I hear you're feeling sad, and I want you to know that's completely valid. These feelings, though difficult, are part of the human experience. ðŸ’™",
                "Sadness can feel heavy, and I'm here to sit with you in it. There's no need to rush through these feelingsâ€”they have their own timing.",
                "I appreciate you sharing that you're feeling sad. It takes courage to acknowledge these emotions. How can I best support you right now?",
                "Your sadness matters, and so do you. Would gentle conversation or a supportive activity feel more helpful at this moment?",
                "I'm with you in this. Sadness often points to what we care deeply about. Would you like to talk about what's coming up for you?"
            ],
            'cheer_up': [
                "I hear you want some cheering up, and that's a proactive step for your wellbeing! Let me help you find some uplifting support. ðŸŒˆ",
                "Wanting to shift from sadness shows self-awareness. I have some encouraging resources that might help lift your spirits.",
                "It takes strength to ask for cheering up when feeling low. Let's explore some options that might bring you some lightness.",
                "I understand you're looking for a mood boost. Here are some uplifting approaches we could try together.",
                "Thank you for letting me know you'd like cheering up. That's an important step in emotional self-care."
            ]
        },
        'lonely': [
            "Loneliness can feel isolating, and I want you to know I'm here with you. These feelings are valid and shared by many. ðŸ’™",
            "I hear the loneliness. It takes courage to acknowledge these feelings. Would companionship through conversation or comforting resources help?",
            "Loneliness can be particularly difficult. I'm here to provide company in whatever way feels supportive right now.",
            "Your feelings of loneliness matter. Sometimes gentle, comforting resources can help ease the sense of isolation.",
            "I'm with you in this loneliness. Would you like to talk about what comes up with these feelings, or try some comforting support?"
        ],
        'angry': [
            "Anger often signals that something important to us feels threatened or unfair. Would you like to explore what's beneath this feeling? ðŸŒ¬ï¸",
            "I hear the frustration in your words. Anger needs safe expressionâ€”would movement, writing, or breath work feel supportive right now?",
            "That anger makes sense given what you're experiencing. Let's find a constructive way to channel this energy together.",
            "Anger can be protective energy. How can we work with it in a way that feels empowering rather than overwhelming?",
            "I'm here with you through this anger. Sometimes naming what we're angry about helps us understand what matters to us most."
        ],
        'anxious': [
            "Anxiety often points to something that feels uncertain or unsafe. Let's ground in what's actually here and now together. ðŸ›¡ï¸",
            "I hear the anxiety in your words. Would you like to try a grounding exercise, or just talk through what's coming up?",
            "That worried feeling is trying to protect you. Let's thank it for its concern, then gently focus on what's within your control.",
            "Anxiety can feel overwhelming, but you're not alone with it. What's the smallest, safest step we could take from here?",
            "I'm here with you through this anxiety. Sometimes breaking it down into manageable pieces helps reduce its intensity."
        ],
        'neutral': [
            "A neutral state can be a peaceful resting place between emotions. Would you like to explore this calm space with gentle curiosity? ðŸƒ",
            "Sometimes 'neutral' is exactly what we needâ€”a breather from emotional intensity. How does this state feel in your body?",
            "Neutrality has its own wisdom. It can be a great opportunity for gentle self-check-in without pressure.",
            "Being in a neutral state allows for reflection without emotional charge. What would feel supportive right now?",
            "I hear you're feeling neutral. This can be a good space to practice mindfulness or simply rest in being."
        ],
        'tired': [
            "Feeling tired can be your system's way of asking for rest and restoration. What would true rest look like for you right now? ðŸ˜´",
            "Fatigue often carries messages about our pace or needs. Let's explore what your body might be telling you.",
            "Rest is productiveâ€”it's how we restore our capacity. What's one small way to honor your need for restoration today?",
            "I hear the tiredness. Sometimes gentle, low-energy activities can be most restorative when we're feeling drained.",
            "Your body is asking for care through this tiredness. How can we support that need together?"
        ]
    }
    
    # Mood-specific YouTube resources (all tested and working) - EXPANDED
    YOUTUBE_RESOURCES = {
        'happy': [  # For happy moods - celebration, energy
            {
                "id": "happy_1",
                "title": "Happy Music Mix - Celebration Vibes",
                "url": "https://www.youtube.com/watch?v=yzTuBuRdAyA",
                "description": "Upbeat songs to amplify your joyful mood and positive energy",
                "energy": "high"
            },
            {
                "id": "happy_2", 
                "title": "Feel Good Dance Music - Positive Energy",
                "url": "https://www.youtube.com/watch?v=2vjPBrBU-TM",
                "description": "Energetic dance tracks to match and enhance your happy mood",
                "energy": "high"
            },
            {
                "id": "happy_3",
                "title": "Upbeat Positive Energy Mix",
                "url": "https://www.youtube.com/watch?v=3sXebXgQy4s",
                "description": "Music to enhance and extend your positive emotional state",
                "energy": "medium"
            },
            {
                "id": "happy_4",
                "title": "Joyful Morning Music",
                "url": "https://www.youtube.com/watch?v=GBZ2T6Q1F3Q",
                "description": "Bright, cheerful music to celebrate your happiness",
                "energy": "medium"
            }
        ],
        'sad': [  # For sad moods - uplifting, comforting
            {
                "id": "sad_1",
                "title": "Uplifting Music for Sad Moments",
                "url": "https://www.youtube.com/watch?v=W6YI3ZFOL0A",
                "description": "Gentle uplifting music to help shift from sadness",
                "energy": "medium"
            },
            {
                "id": "sad_2",
                "title": "Comforting Melodies for Sadness",
                "url": "https://www.youtube.com/watch?v=bP8R0iYQqjE",
                "description": "Soft, comforting music for moments of sadness",
                "energy": "low"
            },
            {
                "id": "sad_3",
                "title": "Hope and Healing Playlist",
                "url": "https://www.youtube.com/watch?v=1ZYbU82GVz4",
                "description": "Music that brings comfort and hope during sad times",
                "energy": "medium_low"
            },
            {
                "id": "sad_4",
                "title": "Gentle Uplift - Mood Transition",
                "url": "https://www.youtube.com/watch?v=4N0-kB-gbDE",
                "description": "Soft instrumental music to gently lift your spirits",
                "energy": "low"
            }
        ],
        'lonely': [  # For loneliness - comforting, companionship
            {
                "id": "lonely_1",
                "title": "Comforting Music for Loneliness",
                "url": "https://www.youtube.com/watch?v=bP8R0iYQqjE",
                "description": "Gentle, comforting melodies for moments of loneliness",
                "energy": "low"
            },
            {
                "id": "lonely_2",
                "title": "You're Not Alone - Comfort Playlist",
                "url": "https://www.youtube.com/watch?v=1ZYbU82GVz4",
                "description": "Soothing music to provide comfort during lonely moments",
                "energy": "low"
            },
            {
                "id": "lonely_3",
                "title": "Gentle Company - Ambient Comfort",
                "url": "https://www.youtube.com/watch?v=4N0-kB-gbDE",
                "description": "Calming ambient music to ease feelings of loneliness",
                "energy": "medium_low"
            },
            {
                "id": "lonely_4",
                "title": "Warm Embrace - Soothing Sounds",
                "url": "https://www.youtube.com/watch?v=4pLVKx1kW-o",
                "description": "Soft, warm music to comfort lonely feelings",
                "energy": "very_low"
            }
        ],
        'anxious': [  # For anxiety - calming, grounding
            {
                "id": "anxious_1",
                "title": "Calm Music for Stress and Anxiety Relief",
                "url": "https://www.youtube.com/watch?v=1ZYbU82GVz4",
                "description": "Soothing ambient music to calm your nervous system",
                "energy": "very_low"
            },
            {
                "id": "anxious_2",
                "title": "Anxiety Relief Music - Immediate Calm",
                "url": "https://www.youtube.com/watch?v=4pLVKx1kW-o",
                "description": "Music specifically designed to reduce anxiety quickly",
                "energy": "very_low"
            },
            {
                "id": "anxious_3",
                "title": "Peaceful Piano for Relaxation",
                "url": "https://www.youtube.com/watch?v=bP8R0iYQqjE",
                "description": "Gentle piano melodies to quiet anxious thoughts",
                "energy": "low"
            },
            {
                "id": "anxious_4",
                "title": "Grounding Music for Anxiety",
                "url": "https://www.youtube.com/watch?v=WRz2MxhAdJo",
                "description": "Stabilizing music to help ground anxious feelings",
                "energy": "low"
            }
        ],
        'angry': [  # For anger - releasing, channeling
            {
                "id": "angry_1",
                "title": "Intense Music for Emotional Release",
                "url": "https://www.youtube.com/watch?v=9bZkp7q19f0",
                "description": "Powerful music to safely match and channel angry energy",
                "energy": "high"
            },
            {
                "id": "angry_2",
                "title": "Calming Music for Anger Management",
                "url": "https://www.youtube.com/watch?v=1ZYbU82GVz4",
                "description": "Soothing sounds to help calm and regulate anger",
                "energy": "low"
            },
            {
                "id": "angry_3",
                "title": "Grounding Music for Emotional Regulation",
                "url": "https://www.youtube.com/watch?v=4N0-kB-gbDE",
                "description": "Focus-oriented music to help center and ground angry feelings",
                "energy": "medium"
            },
            {
                "id": "angry_4",
                "title": "Release and Reset - Anger Channeling",
                "url": "https://www.youtube.com/watch?v=SEfs5TJZ6Nk",
                "description": "Music to help release and transform angry energy",
                "energy": "medium_high"
            }
        ],
        'tired': [  # For tiredness - restoring, gentle
            {
                "id": "tired_1",
                "title": "Relaxing Music for Exhaustion",
                "url": "https://www.youtube.com/watch?v=1ZYbU82GVz4",
                "description": "Gentle music to support rest and recovery when tired",
                "energy": "very_low"
            },
            {
                "id": "tired_2",
                "title": "Sleep Music - Deep Rest",
                "url": "https://www.youtube.com/watch?v=4pLVKx1kW-o",
                "description": "Restorative music for when you need deep rest",
                "energy": "very_low"
            },
            {
                "id": "tired_3",
                "title": "Gentle Uplift for Low Energy",
                "url": "https://www.youtube.com/watch?v=W6YI3ZFOL0A",
                "description": "Soft uplifting music for gentle energy restoration",
                "energy": "low"
            },
            {
                "id": "tired_4",
                "title": "Restorative Ambient Sounds",
                "url": "https://www.youtube.com/watch?v=bP8R0iYQqjE",
                "description": "Calming sounds to support tired mind and body",
                "energy": "very_low"
            }
        ],
        'neutral': [  # For neutral moods - balancing, focusing
            {
                "id": "neutral_1",
                "title": "Lofi Hip Hop Radio - Beats to Relax/Study",
                "url": "https://www.youtube.com/watch?v=5qap5aO4i9A",
                "description": "Balanced background music for neutral or focused states",
                "energy": "medium"
            },
            {
                "id": "neutral_2",
                "title": "Focus Music for Concentration",
                "url": "https://www.youtube.com/watch?v=4N0-kB-gbDE",
                "description": "Music to enhance focus during neutral emotional states",
                "energy": "medium"
            },
            {
                "id": "neutral_3",
                "title": "Ambient Study Music",
                "url": "https://www.youtube.com/watch?v=WRz2MxhAdJo",
                "description": "Neutral ambient music for calm productivity",
                "energy": "medium_low"
            },
            {
                "id": "neutral_4",
                "title": "Calm Background Music",
                "url": "https://www.youtube.com/watch?v=bP8R0iYQqjE",
                "description": "Gentle background music for neutral moments",
                "energy": "low"
            }
        ]
    }
    
    # Enhanced motivational quotes with variety
    QUOTE_CATEGORIES = {
        'motivational': [
            "Progress isn't about giant leaps, but about the small, consistent steps we take each day. What's one tiny step forward you could take right now? ðŸ’«",
            "You are capable of amazing thingsâ€”not because you're superhuman, but because you're human with inherent capacity for growth and adaptation.",
            "Remember: You've already survived 100% of your difficult days. That's evidence of resilience you carry forward.",
            "Small steps still move you forward. Momentum builds from action, no matter how small the initial movement.",
            "Your mental health is a priority, not a luxury. Investing in it is one of the most important commitments you can make.",
            "Be gentle with yourself today. Self-compassion is correlated with greater resilience and wellbeing than self-criticism.",
            "One day at a time, sometimes one moment at a time. Healing and growth follow their own timeline.",
            "You're doing better than you think. Our inner critics often magnify struggles while minimizing strengths.",
            "This feeling is temporary. Emotions are visitorsâ€”they come, stay awhile, and eventually make space for others.",
            "You are enough, just as you are. Worth isn't earned through productivity or perfection."
        ],
        'emotional': [
            "Your feelings are valid messengers, not problems to be solved. They're telling you something important about your needs and values.",
            "It's okay to not be okay. Authenticity in our emotional experience is the foundation of genuine wellbeing.",
            "Healing isn't linear. It's more like a spiralâ€”we revisit similar places but from new perspectives each time.",
            "Vulnerability is the birthplace of connection and meaning. Sharing our true emotional experience creates authentic relating.",
            "Emotions are energy in motion. They want to move through us, not get stuck within us.",
            "The depth of your feelings reflects the depth of your capacity to experience life fully.",
            "All emotions have intelligence. Even difficult ones carry information about what matters to us.",
            "Being with difficult emotions without judgment is one of the most courageous forms of self-care.",
            "Your emotional landscape is uniquely yoursâ€”there's no 'right' way to navigate it.",
            "Feelings aren't facts, but they are real experiences deserving of acknowledgement."
        ],
        'mindfulness': [
            "This moment, right now, is the only one you have for sure. What do you notice about your present experience? â³",
            "Be where you are, not where you think you should be. Presence is the foundation of peace.",
            "Feelings come and go like clouds in a windy sky. Conscious breathing is your anchor to the present.",
            "The breath you're taking right now is the only one that exists. The next one hasn't arrived yet.",
            "Ground yourself in what's real: the sensation of breathing, the surface beneath you, the sounds around you.",
            "Mindfulness isn't about emptying the mind, but about noticing what's already there without judgment.",
            "Between stimulus and response there is a space. In that space lies our freedom to choose.",
            "Presence is the greatest gift we can give ourselvesâ€”and it's always available, right here, right now.",
            "Notice without judgment, feel without resistance, be without striving.",
            "The present moment holds everything you need for your next step forward."
        ]
    }
    
    # Professional greetings
    GREETINGS = [
        "Hello! I'm here to support your mental wellness journey. How are you arriving to our conversation today? ðŸ˜Š",
        "Welcome! Let's begin by checking in with where you are right nowâ€”emotionally, mentally, physically. What's present for you?",
        "Hi there! I'm ready to listen and support in whatever way feels right for you today. How can I be most helpful?",
        "Hello! Before we dive in, take a conscious breath. I'm here to meet you exactly where you are. What would you like to explore? ðŸŒŸ"
    ]
    
    # Enhanced farewells
    FAREWELLS = [
        "Thank you for sharing this time with me. Remember to carry forward whatever was helpful, and leave what wasn't. Take gentle care of yourself today. ðŸŒˆ",
        "Our conversation matters. I appreciate you investing in your mental wellbeing. Wishing you peace and clarity as you move through your day. âœ¨",
        "I'm grateful for our connection today. Remember: You have resources within you, and support around you. Be kind to yourself. ðŸ’–",
        "Thank you for trusting me with your experience. May you move forward with greater self-awareness and compassion. You've got this! ðŸŒŸ"
    ]
    
    @classmethod
    def _reset_state(cls):
        """Reset conversation state"""
        cls._conversation_state = {
            'last_quotes_given': [],
            'last_songs_given': [],
            'cheer_up_context': False,
            'last_interaction': None,
            'interaction_count': 0,
            'current_mood': None
        }
    
    @classmethod
    def _update_state(cls, user_message: str, response: str, mood: str = None):
        """Update conversation state"""
        cls._conversation_state['interaction_count'] += 1
        cls._conversation_state['last_interaction'] = {
            'timestamp': datetime.now(),
            'user_message': user_message[:100],
            'response': response[:100]
        }
        
        if mood:
            cls._conversation_state['current_mood'] = mood
        
        # Reset cheer up context UNLESS explicitly mentioned
        if 'cheer' not in user_message.lower() and 'up' not in user_message.lower():
            cls._conversation_state['cheer_up_context'] = False
    
    @classmethod
    def _get_fresh_quote(cls, category: str = 'motivational') -> str:
        """Get a quote that hasn't been given recently"""
        available_quotes = cls.QUOTE_CATEGORIES.get(category, cls.QUOTE_CATEGORIES['motivational'])
        
        # Remove recently given quotes
        fresh_quotes = [q for q in available_quotes if q not in cls._conversation_state['last_quotes_given']]
        
        # If all quotes have been used, reset and use any
        if not fresh_quotes:
            cls._conversation_state['last_quotes_given'] = []
            fresh_quotes = available_quotes
        
        # Select and track quote
        selected_quote = random.choice(fresh_quotes)
        cls._conversation_state['last_quotes_given'].append(selected_quote)
        
        # Keep only last 5 quotes
        if len(cls._conversation_state['last_quotes_given']) > 5:
            cls._conversation_state['last_quotes_given'] = cls._conversation_state['last_quotes_given'][-5:]
        
        return selected_quote
    
    @classmethod
    def _get_fresh_song(cls, mood: str = None, is_cheer_up: bool = False) -> Dict:
        """Get a song that hasn't been given recently for this mood"""
        if not mood or mood not in cls.YOUTUBE_RESOURCES:
            mood = 'neutral'
        
        # Get resources for this mood
        mood_resources = cls.YOUTUBE_RESOURCES.get(mood, cls.YOUTUBE_RESOURCES['neutral'])
        
        # For cheer up requests with sad mood, filter for uplifting energy
        if mood == 'sad' and is_cheer_up:
            mood_resources = [r for r in mood_resources if r['energy'] in ['medium', 'high']]
        
        # Filter out recently given songs
        fresh_resources = [r for r in mood_resources if r['id'] not in cls._conversation_state['last_songs_given']]
        
        # If all songs have been used, reset for this mood
        if not fresh_resources:
            # Keep songs from other moods, only reset this mood's songs
            cls._conversation_state['last_songs_given'] = [
                song_id for song_id in cls._conversation_state['last_songs_given']
                if not song_id.startswith(f"{mood}_")
            ]
            fresh_resources = mood_resources
        
        # Select and track song
        selected_resource = random.choice(fresh_resources)
        cls._conversation_state['last_songs_given'].append(selected_resource['id'])
        
        # Keep only last 8 songs
        if len(cls._conversation_state['last_songs_given']) > 8:
            cls._conversation_state['last_songs_given'] = cls._conversation_state['last_songs_given'][-8:]
        
        return selected_resource
    
    @classmethod
    def _get_mood_specific_youtube_resource(cls, mood: str = None, is_cheer_up: bool = False) -> str:
        """Get mood-specific YouTube resource without repetition"""
        if not mood or mood not in cls.YOUTUBE_RESOURCES:
            mood = 'neutral'
        
        # Get fresh song for this mood
        resource = cls._get_fresh_song(mood, is_cheer_up)
        
        # Create appropriate introduction based on mood
        mood_intros = {
            'happy': "To amplify your happy mood, here's some celebratory music:\n\n",
            'sad': "For your current mood, here's some supportive music:\n\n",
            'lonely': "For moments of loneliness, here's some comforting music:\n\n",
            'anxious': "To help calm and ground your anxiety, try this:\n\n",
            'angry': "To help channel or calm your anger, this might help:\n\n",
            'tired': "For restorative support when feeling tired:\n\n",
            'neutral': "For your current state, here's some balanced music:\n\n"
        }
        
        intro = mood_intros.get(mood, "Here's some supportive music:\n\n")
        
        # Override for cheer up requests
        if is_cheer_up:
            if mood == 'sad':
                intro = "To help cheer you up, here's some uplifting music:\n\n"
            else:
                intro = "To boost your mood, here's some uplifting music:\n\n"
        
        return f"{intro}ðŸŽµ **{resource['title']}**\nðŸ”— {resource['url']}\nðŸ’¡ {resource['description']}\n\nðŸ“ Copy the URL above and paste into your browser to open YouTube"
    
    @classmethod
    def get_response(cls, user_message: str, user_mood: Optional[str] = None) -> str:
        """Generate enhanced chatbot response"""
        user_message_lower = user_message.lower().strip()
        
        # Reset state on new conversation
        if cls._conversation_state['interaction_count'] == 0:
            cls._reset_state()
        
        # Detect mood from message if not provided
        detected_mood = user_mood or cls.analyze_mood_from_text(user_message)
        
        # Handle "thank you" and "thanks" as farewells
        if user_message_lower in ['thank you', 'thanks', 'thank u', 'thx']:
            response = random.choice(cls.FAREWELLS)
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Handle "how are you" specifically
        if user_message_lower in ['how are you', 'how are you?', 'how are u', 'how r u']:
            response = random.choice([
                "Thank you for asking! I'm here and fully present to support you. How are you feeling today?",
                "I'm doing well, and I'm focused on being here for you. How has your day been so far?",
                "I'm present and ready to listen. Thanks for checking in! How are you really doing?",
            ])
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Check for greetings
        greetings = ['hello', 'hi', 'hey', 'greetings']
        if any(greet in user_message_lower for greet in greetings) and cls._conversation_state['interaction_count'] < 2:
            response = random.choice(cls.GREETINGS)
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Check for farewells
        farewells = ['bye', 'goodbye', 'see you', 'farewell', 'quit', 'exit']
        if any(farewell in user_message_lower for farewell in farewells):
            response = random.choice(cls.FAREWELLS)
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Check for song/music requests - FIXED SECTION
        if any(word in user_message_lower for word in ['song', 'music', 'playlist', 'youtube', 'listen']):
            # Check if this is a cheer up request
            is_cheer_up = 'cheer' in user_message_lower and 'up' in user_message_lower
            
            # If user explicitly says their mood, use that mood
            if detected_mood:
                # For cheer up requests with sad mood, keep cheer up context
                if is_cheer_up and detected_mood == 'sad':
                    cls._conversation_state['cheer_up_context'] = True
                else:
                    # Reset cheer up context for other moods
                    cls._conversation_state['cheer_up_context'] = False
            else:
                # Use current mood from state if no mood detected
                detected_mood = cls._conversation_state.get('current_mood', 'neutral')
            
            # Get mood-appropriate resource
            response = cls._get_mood_specific_youtube_resource(detected_mood, is_cheer_up)
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Check for quote requests
        if 'quote' in user_message_lower or 'quotes' in user_message_lower:
            # Determine quote category based on mood
            if detected_mood in ['anxious', 'sad', 'lonely']:
                category = 'emotional'
            elif detected_mood == 'happy':
                category = 'motivational'
            else:
                category = 'mindfulness'
            
            # Check if asking for "another" quote
            if 'another' in user_message_lower or 'more' in user_message_lower or 'different' in user_message_lower:
                quote = cls._get_fresh_quote(category)
                response = f"Here's another thought for you:\n\n\"{quote}\""
            else:
                quote = cls._get_fresh_quote(category)
                response = f"Here's a perspective that might resonate:\n\n\"{quote}\""
            
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Check for cheer up requests
        if 'cheer' in user_message_lower and 'up' in user_message_lower:
            cls._conversation_state['cheer_up_context'] = True
            
            if 'sad' in user_message_lower or detected_mood == 'sad':
                response = random.choice(cls.MOOD_RESPONSES['sad']['cheer_up'])
                response += "\n\n" + cls._get_mood_specific_youtube_resource('sad', True)
            else:
                response = "I'd be happy to help cheer you up! "
                response += cls._get_mood_specific_youtube_resource(detected_mood or 'neutral', True)
            
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Mood-based responses
        if detected_mood and detected_mood in cls.MOOD_RESPONSES:
            if detected_mood == 'sad':
                if cls._conversation_state['cheer_up_context']:
                    responses = cls.MOOD_RESPONSES['sad']['cheer_up']
                else:
                    responses = cls.MOOD_RESPONSES['sad']['general']
            else:
                responses = cls.MOOD_RESPONSES[detected_mood]
            
            response = random.choice(responses)
            
            cls._update_state(user_message, response, detected_mood)
            return response
        
        # Default empathetic responses
        empathetic_responses = [
            "Thank you for sharing that with me. I'm listening with care and attention. ðŸ¤—",
            "I hear you. Would you like to explore this further, or would supportive resources be more helpful right now? ðŸ’­",
            "That sounds important. How is this sitting with you emotionally and physically?",
            "I'm fully present with what you're sharing. Your experience matters here. ðŸ’«",
            "Thank you for being open with me. Let's proceed in whatever way feels most supportive for you. ðŸŒŸ"
        ]
        
        response = random.choice(empathetic_responses)
        cls._update_state(user_message, response, detected_mood)
        return response
    
    @staticmethod
    def analyze_mood_from_text(text):
        """Enhanced mood detection from text"""
        text_lower = text.lower()
        
        # Check for specific moods first
        if 'lonely' in text_lower or 'alone' in text_lower:
            return 'lonely'
        if 'tired' in text_lower or 'exhausted' in text_lower:
            return 'tired'
        if 'anxious' in text_lower or 'anxiety' in text_lower:
            return 'anxious'
        if 'angry' in text_lower or 'mad' in text_lower:
            return 'angry'
        if 'happy' in text_lower or 'joy' in text_lower:
            return 'happy'
        if 'sad' in text_lower or 'unhappy' in text_lower:
            return 'sad'
        
        # Default keyword matching
        mood_keywords = {
            'happy': ['good', 'great', 'wonderful', 'excited', 'love', 'amazing', 'fantastic', 'joyful'],
            'sad': ['depressed', 'cry', 'tears', 'miserable', 'bad', 'terrible', 'down', 'low'],
            'neutral': ['okay', 'fine', 'normal', 'alright', 'meh', 'whatever', 'ok', 'neutral']
        }
        
        scores = {mood: 0 for mood in mood_keywords}
        
        for mood, keywords in mood_keywords.items():
            for keyword in keywords:
                if keyword in text_lower:
                    scores[mood] += 1
        
        if all(score == 0 for score in scores.values()):
            return None
        
        return max(scores, key=scores.get)